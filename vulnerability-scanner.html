<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Shield360 Research | Vulnerability Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</head>

<body class="bg-gray-900 min-h-screen flex flex-col text-gray-100">

  <!-- Header -->
  <header class="bg-black border-b border-gray-800 py-6 shadow-lg">
    <div class="max-w-7xl mx-auto px-6">
      <div class="flex items-center justify-between flex-wrap gap-4">
        <div class="flex items-center gap-4">
          <!-- Back Button -->
          <a id="backBtn" href="index.html" class="flex items-center gap-2 px-3 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition-colors duration-200" aria-label="Back to Dashboard">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            <span class="hidden sm:inline text-sm font-medium">Back</span>
          </a>
          <div class="h-8 w-px bg-white/20 hidden sm:block"></div>
          <div>
            <h1 class="text-3xl font-bold tracking-wide flex items-center gap-3">
              <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
              </svg>
              Shield360 Research
            </h1>
            <p class="text-gray-400 mt-1">Vulnerability Scanner – NVD Integration</p>
          </div>
        </div>
        <div class="flex gap-3">
          <button id="scanBtn" onclick="startScan()" 
                  class="px-6 py-3 bg-red-600 hover:bg-red-700 rounded-lg font-semibold flex items-center gap-2 transition disabled:opacity-50 disabled:cursor-not-allowed">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            Scan for Vulnerabilities
          </button>
          <button id="exportBtn" onclick="exportReport()" 
                  class="hidden px-4 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg font-semibold flex items-center gap-2 transition">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            Export
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-1 p-6 max-w-7xl mx-auto w-full">

    <!-- Endpoint Info Banner -->
    <div id="endpointBanner" class="hidden bg-gray-800 rounded-xl p-4 mb-6 border border-gray-700">
      <div class="flex items-center justify-between flex-wrap gap-3">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-blue-500/20 rounded-lg flex items-center justify-center">
            <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2"></path>
            </svg>
          </div>
          <div>
            <p class="text-sm text-gray-400">Scanning Endpoint</p>
            <p id="endpointHostname" class="text-lg font-semibold text-white">Loading...</p>
          </div>
        </div>
        <div class="flex items-center gap-4 text-sm">
          <div>
            <span class="text-gray-400">OS:</span>
            <span id="endpointOS" class="text-white ml-1">-</span>
          </div>
          <div>
            <span class="text-gray-400">IP:</span>
            <span id="endpointIP" class="text-white ml-1 font-mono">-</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Stats Dashboard -->
    <div id="statsDashboard" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
      <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
        <p class="text-3xl font-bold text-white" id="totalEndpoints">-</p>
        <p class="text-sm text-gray-400">Endpoints</p>
      </div>
      <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
        <p class="text-3xl font-bold text-blue-400" id="totalApps">-</p>
        <p class="text-sm text-gray-400">Applications</p>
      </div>
      <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
        <p class="text-3xl font-bold text-red-500" id="criticalCount">-</p>
        <p class="text-sm text-gray-400">Critical</p>
      </div>
      <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
        <p class="text-3xl font-bold text-orange-500" id="highCount">-</p>
        <p class="text-sm text-gray-400">High</p>
      </div>
      <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
        <p class="text-3xl font-bold text-yellow-500" id="mediumCount">-</p>
        <p class="text-sm text-gray-400">Medium</p>
      </div>
      <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
        <p class="text-3xl font-bold text-green-500" id="lowCount">-</p>
        <p class="text-sm text-gray-400">Low</p>
      </div>
    </div>

    <!-- Progress Section -->
    <div id="progressSection" class="hidden mb-6">
      <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
        <div class="flex items-center justify-between mb-3">
          <span class="text-lg font-semibold flex items-center gap-2">
            <svg class="animate-spin h-5 w-5 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Scanning in Progress...
          </span>
          <span id="progressText" class="text-gray-400">0 / 0</span>
        </div>
        <div class="w-full bg-gray-700 rounded-full h-3">
          <div id="progressBar" class="bg-gradient-to-r from-red-600 to-orange-500 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
        <p id="progressStatus" class="text-sm text-gray-400 mt-2">Initializing...</p>
        <p id="progressNote" class="text-xs text-gray-500 mt-1">Note: NVD API requires 6-second delay between requests (no API key)</p>
      </div>
    </div>

    <!-- Loader -->
    <div id="loader" class="text-center mt-16">
      <div class="inline-flex items-center gap-3">
        <svg class="animate-spin h-8 w-8 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span class="text-gray-400 text-lg">Loading endpoint data from Firestore...</span>
      </div>
    </div>

    <!-- Error -->
    <div id="error" class="hidden text-center mt-16">
      <div class="inline-block bg-red-900/50 border border-red-700 rounded-lg p-6 max-w-md">
        <svg class="mx-auto h-12 w-12 text-red-500 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
        </svg>
        <p class="text-red-400 font-semibold" id="errorMessage">Failed to load data</p>
        <p class="text-red-500 text-sm mt-1" id="errorDetails"></p>
        <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
          Try Again
        </button>
      </div>
    </div>

    <!-- Applications Overview -->
    <div id="appsContainer" class="hidden mb-8">
      <div class="flex items-center justify-between mb-4 flex-wrap gap-2">
        <h2 class="text-xl font-semibold flex items-center gap-2">
          <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
          </svg>
          Installed Applications
          <span id="appFilterCount" class="text-sm text-gray-500 font-normal"></span>
        </h2>
        <input type="text" id="appSearch" placeholder="Search applications..." 
               class="px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-sm focus:border-gray-600 focus:outline-none w-64"
               oninput="filterApplications()">
      </div>
      <div id="appsGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3 max-h-[400px] overflow-y-auto pr-2"></div>
    </div>

    <!-- Vulnerability Results -->
    <div id="vulnResults" class="hidden">
      <div class="flex items-center justify-between mb-4 flex-wrap gap-2">
        <h2 class="text-xl font-semibold flex items-center gap-2">
          <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
          </svg>
          Vulnerability Scan Results
        </h2>
        <select id="severityFilter" onchange="filterVulnerabilities()" 
                class="px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-sm">
          <option value="all">All Severities</option>
          <option value="CRITICAL">Critical Only</option>
          <option value="HIGH">High & Above</option>
          <option value="MEDIUM">Medium & Above</option>
        </select>
      </div>
      <div id="vulnGrid" class="space-y-4"></div>
    </div>

  </main>

  <!-- Footer -->
  <footer class="text-center text-sm text-gray-500 py-4 border-t border-gray-800 bg-black">
    © 2026 Shield360 Research | Powered by Firebase & NVD API
  </footer>

  <!-- Firebase + NVD Integration -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    /* ===============================
       Configuration
    ================================ */
    const firebaseConfig = {
      apiKey: "AIzaSyDgLbcxEKfUS8q-Qoq8CVIOsG4Wk1EjedY",
      authDomain: "shield360-research.firebaseapp.com",
      projectId: "shield360-research",
      storageBucket: "shield360-research.firebasestorage.app",
      messagingSenderId: "976942887666",
      appId: "1:976942887666:web:f3176543a19681b59a566b",
      measurementId: "G-6B02NRCY1S"
    };

    const COLLECTION_NAME = "endpoints";
    const NVD_API_BASE = "https://services.nvd.nist.gov/rest/json/cves/2.0";
    const API_DELAY_MS = 6500;
    const API_RATE_LIMIT_RETRY_MS = 30000;

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Global state
    let currentEndpoint = null;
    let allApplications = [];
    let vulnerabilityResults = [];

    /* ===============================
       Helper Functions
    ================================ */
    function escapeHtml(text) {
      if (text === null || text === undefined) return "";
      const div = document.createElement("div");
      div.textContent = String(text);
      return div.innerHTML;
    }

    function getSeverityBadgeClass(severity) {
      switch ((severity || "").toUpperCase()) {
        case "CRITICAL": return "bg-red-600 text-white";
        case "HIGH": return "bg-orange-600 text-white";
        case "MEDIUM": return "bg-yellow-600 text-black";
        case "LOW": return "bg-green-600 text-white";
        default: return "bg-gray-600 text-white";
      }
    }

    function getSeverityBorderClass(severity) {
      switch ((severity || "").toUpperCase()) {
        case "CRITICAL": return "border-red-500";
        case "HIGH": return "border-orange-500";
        case "MEDIUM": return "border-yellow-500";
        case "LOW": return "border-green-500";
        default: return "border-gray-700";
      }
    }

    // Extract clean product name for NVD search
    function extractProductName(appName) {
      let name = appName;
      
      // Remove common suffixes
      name = name.replace(/\s*\(64-bit\)/gi, "");
      name = name.replace(/\s*\(32-bit\)/gi, "");
      name = name.replace(/\s*x64\s*/gi, " ");
      name = name.replace(/\s*x86\s*/gi, " ");
      
      // Remove version patterns embedded in name
      name = name.replace(/\s+\d+\.\d+(\.\d+)*(\.\d+)?\s*/g, " ");
      
      // Known product mappings
      const mappings = [
        { pattern: /^Python\s+.*/i, result: "Python" },
        { pattern: /^Microsoft\s+Visual\s+C\+\+.*/i, result: "Microsoft Visual C++ Redistributable" },
        { pattern: /^Microsoft\s+\.NET.*/i, result: "Microsoft .NET" },
        { pattern: /^Microsoft\s+Teams.*/i, result: "Microsoft Teams" },
        { pattern: /^Office\s+\d+\s+Click-to-Run.*/i, result: "Microsoft Office Click-to-Run" },
        { pattern: /^Node\.js.*/i, result: "Node.js" },
        { pattern: /^VMware\s+Workstation.*/i, result: "VMware Workstation" },
        { pattern: /^Oracle\s+VirtualBox.*/i, result: "Oracle VirtualBox" },
        { pattern: /^NVIDIA\s+Nsight.*/i, result: "NVIDIA Nsight" },
        { pattern: /^NVIDIA\s+.*/i, result: (m) => m[0].split(/\s+/).slice(0, 2).join(" ") },
        { pattern: /^ESET\s+Endpoint.*/i, result: "ESET Endpoint Security" },
        { pattern: /^ESET\s+Management.*/i, result: "ESET Management Agent" },
        { pattern: /^RustDesk.*/i, result: "RustDesk" },
        { pattern: /^Windows\s+Subsystem\s+for\s+Linux.*/i, result: "Windows Subsystem for Linux" },
        { pattern: /^ASUS\s+.*/i, result: (m) => m[0].split(/\s+/).slice(0, 2).join(" ") },
        { pattern: /^AURA\s+.*/i, result: "ASUS AURA" },
      ];

      for (const map of mappings) {
        const match = name.match(map.pattern);
        if (match) {
          return typeof map.result === "function" ? map.result(match) : map.result;
        }
      }

      // Clean up and truncate
      name = name.replace(/\s+/g, " ").trim();
      const words = name.split(" ");
      if (words.length > 4) {
        name = words.slice(0, 4).join(" ");
      }

      return name;
    }

    function extractVersion(versionStr) {
      if (!versionStr) return null;
      const match = versionStr.match(/(\d+)\.(\d+)(?:\.(\d+))?/);
      if (match) {
        return {
          major: parseInt(match[1]),
          minor: parseInt(match[2]),
          patch: match[3] ? parseInt(match[3]) : 0,
          full: match[0]
        };
      }
      return null;
    }

    function groupApplications(apps) {
      const groups = new Map();
      
      for (const app of apps) {
        const key = extractProductName(app.name);
        if (!groups.has(key)) {
          groups.set(key, {
            productName: key,
            applications: [],
            versions: new Set(),
            originalNames: new Set()
          });
        }
        const group = groups.get(key);
        group.applications.push(app);
        group.originalNames.add(app.name);
        if (app.version) {
          const ver = extractVersion(app.version);
          if (ver) {
            group.versions.add(ver.full);
          }
        }
      }

      return Array.from(groups.values());
    }

    function getHighestSeverity(vulns) {
      const order = ["CRITICAL", "HIGH", "MEDIUM", "LOW"];
      for (const sev of order) {
        if (vulns.some(v => v.severity === sev)) return sev;
      }
      return "LOW";
    }

    /* ===============================
       Get Endpoint ID from URL
    ================================ */
    function getEndpointIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get("id");
    }

    /* ===============================
       Load Firestore Endpoint
    ================================ */
    async function loadEndpoint() {
      const endpointId = getEndpointIdFromUrl();
      
      if (!endpointId) {
        showError("No Endpoint Specified", "Please select an endpoint from the dashboard to scan for vulnerabilities.");
        return;
      }

      try {
        const docRef = doc(db, COLLECTION_NAME, endpointId);
        const docSnap = await getDoc(docRef);
        
        document.getElementById("loader").classList.add("hidden");

        if (!docSnap.exists()) {
          showError("Endpoint Not Found", `The endpoint with ID "${endpointId}" could not be found.`);
          return;
        }

        const data = docSnap.data();
        currentEndpoint = { id: docSnap.id, ...data };
        
        // Update back button to return to endpoint details
        const backBtn = document.getElementById("backBtn");
        backBtn.href = `endpoint.html?id=${encodeURIComponent(endpointId)}`;

        // Update endpoint banner
        const hostname = data.hostname || data.id || "Unknown Endpoint";
        const osInfo = data.os_info || {};
        const network = data.network || {};
        
        document.getElementById("endpointHostname").textContent = hostname;
        document.getElementById("endpointOS").textContent = osInfo.name || "Unknown";
        document.getElementById("endpointIP").textContent = network.public_ip || "N/A";
        document.getElementById("endpointBanner").classList.remove("hidden");

        // Extract applications array from endpoint
        const apps = data.applications || data.Applications || [];
        allApplications = [];
        
        if (Array.isArray(apps)) {
          for (const app of apps) {
            if (app.name || app.Name) {
              allApplications.push({
                name: app.name || app.Name,
                version: app.version || app.Version || "",
                endpointId: docSnap.id
              });
            }
          }
        }

        console.log("Endpoint:", currentEndpoint.id);
        console.log("Applications:", allApplications.length);

        document.getElementById("totalEndpoints").textContent = "1";
        document.getElementById("totalApps").textContent = allApplications.length;

        renderApplications();
        document.getElementById("appsContainer").classList.remove("hidden");

      } catch (error) {
        console.error("Firestore Error:", error);
        showError("Failed to load endpoint", error.message);
      }
    }

    /* ===============================
       Render Applications
    ================================ */
    window.filterApplications = function() {
      renderApplications();
    };

    function renderApplications() {
      const searchTerm = document.getElementById("appSearch").value.toLowerCase();
      const filtered = allApplications.filter(app => 
        app.name.toLowerCase().includes(searchTerm) ||
        (app.version && app.version.toLowerCase().includes(searchTerm))
      );

      document.getElementById("appFilterCount").textContent = 
        searchTerm ? `(${filtered.length} of ${allApplications.length})` : `(${allApplications.length} total)`;

      const grid = document.getElementById("appsGrid");
      grid.innerHTML = "";

      const grouped = groupApplications(filtered);
      
      for (const group of grouped.slice(0, 60)) {
        const vulnData = vulnerabilityResults.find(v => v.productName === group.productName);
        const hasVulns = vulnData && vulnData.vulnerabilities.length > 0;
        const severity = hasVulns ? getHighestSeverity(vulnData.vulnerabilities) : null;

        const card = document.createElement("div");
        card.className = `bg-gray-800 rounded-lg p-4 border ${hasVulns ? getSeverityBorderClass(severity) : 'border-gray-700'} hover:bg-gray-750 transition`;
        
        const versions = Array.from(group.versions).slice(0, 2).join(", ");
        const moreVersions = group.versions.size > 2 ? ` +${group.versions.size - 2}` : "";

        card.innerHTML = `
          <div class="flex justify-between items-start gap-2">
            <div class="min-w-0 flex-1">
              <h3 class="font-medium text-white truncate" title="${escapeHtml(group.productName)}">${escapeHtml(group.productName)}</h3>
              <p class="text-xs text-gray-400 mt-1">
                ${group.applications.length} instance${group.applications.length > 1 ? 's' : ''} 
                ${versions ? `• v${versions}${moreVersions}` : ''}
              </p>
            </div>
            ${hasVulns ? `
              <span class="px-2 py-1 text-xs font-bold rounded flex-shrink-0 ${getSeverityBadgeClass(severity)}">
                ${vulnData.vulnerabilities.length} CVE
              </span>
            ` : ''}
          </div>
        `;
        
        grid.appendChild(card);
      }

      if (grouped.length > 60) {
        const more = document.createElement("div");
        more.className = "col-span-full text-center text-gray-500 py-2 text-sm";
        more.textContent = `+ ${grouped.length - 60} more (use search to filter)`;
        grid.appendChild(more);
      }
    }

    /* ===============================
       NVD API
    ================================ */
    async function searchNVD(keyword) {
      try {
        const url = `${NVD_API_BASE}?keywordSearch=${encodeURIComponent(keyword)}&resultsPerPage=50`;
        console.log("NVD Search:", keyword);

        const response = await fetch(url);
        
        if (!response.ok) {
          if (response.status === 403) {
            return { error: "rate_limited", vulnerabilities: [] };
          }
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        console.log("NVD Results:", keyword, "->", data.totalResults);

        const vulns = [];
        
        if (data.vulnerabilities) {
          for (const item of data.vulnerabilities) {
            const cve = item.cve;
            
            let score = null, severity = "UNKNOWN", vector = "";

            if (cve.metrics?.cvssMetricV31?.[0]) {
              const c = cve.metrics.cvssMetricV31[0].cvssData;
              score = c.baseScore;
              severity = c.baseSeverity;
              vector = c.vectorString;
            } else if (cve.metrics?.cvssMetricV30?.[0]) {
              const c = cve.metrics.cvssMetricV30[0].cvssData;
              score = c.baseScore;
              severity = c.baseSeverity;
              vector = c.vectorString;
            } else if (cve.metrics?.cvssMetricV2?.[0]) {
              const c = cve.metrics.cvssMetricV2[0].cvssData;
              score = c.baseScore;
              severity = score >= 7.0 ? "HIGH" : score >= 4.0 ? "MEDIUM" : "LOW";
              vector = c.vectorString;
            }

            const desc = cve.descriptions?.find(d => d.lang === "en")?.value || "No description";

            vulns.push({
              id: cve.id,
              description: desc,
              score,
              severity,
              vector,
              published: cve.published,
              lastModified: cve.lastModified
            });
          }
        }

        vulns.sort((a, b) => (b.score || 0) - (a.score || 0));
        return { vulnerabilities: vulns, totalResults: data.totalResults };

      } catch (error) {
        console.error("NVD Error:", error);
        return { error: error.message, vulnerabilities: [] };
      }
    }

    /* ===============================
       Scan
    ================================ */
    window.startScan = async function() {
      if (allApplications.length === 0) {
        alert("No applications loaded.");
        return;
      }

      const groups = groupApplications(allApplications);
      
      // Filter to meaningful products
      const scannable = groups.filter(g => {
        const n = g.productName.toLowerCase();
        return !n.includes("add to path") &&
               !n.includes("pip bootstrap") &&
               !n.includes("utility scripts") &&
               !n.includes("test suite") &&
               !n.includes("documentation") &&
               !n.includes("development libraries") &&
               !n.includes("standard library") &&
               !n.includes("core interpreter") &&
               !n.includes("executables") &&
               !n.includes("tcl/tk") &&
               n.length > 3;
      });

      console.log("Scanning:", scannable.length, "products");

      const scanBtn = document.getElementById("scanBtn");
      scanBtn.disabled = true;
      scanBtn.innerHTML = `<svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg> Scanning...`;
      
      document.getElementById("progressSection").classList.remove("hidden");
      document.getElementById("vulnResults").classList.add("hidden");
      document.getElementById("vulnGrid").innerHTML = "";
      vulnerabilityResults = [];

      let critical = 0, high = 0, medium = 0, low = 0;

      for (let i = 0; i < scannable.length; i++) {
        const group = scannable[i];
        const progress = Math.round(((i + 1) / scannable.length) * 100);
        
        document.getElementById("progressBar").style.width = `${progress}%`;
        document.getElementById("progressText").textContent = `${i + 1} / ${scannable.length}`;
        document.getElementById("progressStatus").textContent = `Scanning: ${group.productName}`;

        if (i > 0) {
          const delaySeconds = Math.ceil(API_DELAY_MS / 1000);
          for (let sec = delaySeconds; sec > 0; sec--) {
            document.getElementById("progressStatus").textContent = `Rate limit: ${sec}s... Next: ${group.productName}`;
            await new Promise(r => setTimeout(r, 1000));
          }
        }

        let result = await searchNVD(group.productName);

        if (result.error === "rate_limited") {
          const retrySeconds = Math.ceil(API_RATE_LIMIT_RETRY_MS / 1000);
          document.getElementById("progressStatus").textContent = `Rate limited - waiting ${retrySeconds}s...`;
          await new Promise(r => setTimeout(r, API_RATE_LIMIT_RETRY_MS));
          result = await searchNVD(group.productName);
        }

        if (result.vulnerabilities.length > 0) {
          vulnerabilityResults.push({
            productName: group.productName,
            versions: Array.from(group.versions),
            instanceCount: group.applications.length,
            vulnerabilities: result.vulnerabilities,
            totalResults: result.totalResults
          });

          for (const v of result.vulnerabilities) {
            switch (v.severity) {
              case "CRITICAL": critical++; break;
              case "HIGH": high++; break;
              case "MEDIUM": medium++; break;
              default: low++; break;
            }
          }
        }

        document.getElementById("criticalCount").textContent = critical;
        document.getElementById("highCount").textContent = high;
        document.getElementById("mediumCount").textContent = medium;
        document.getElementById("lowCount").textContent = low;
      }

      document.getElementById("progressSection").classList.add("hidden");
      scanBtn.disabled = false;
      scanBtn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg> Scan Again`;

      renderApplications();
      renderVulnerabilityResults();
      
      if (vulnerabilityResults.length > 0) {
        document.getElementById("exportBtn").classList.remove("hidden");
      }
    };

    /* ===============================
       Render Results
    ================================ */
    window.filterVulnerabilities = function() {
      renderVulnerabilityResults();
    };

    function renderVulnerabilityResults() {
      const filter = document.getElementById("severityFilter").value;
      const grid = document.getElementById("vulnGrid");
      grid.innerHTML = "";
      
      if (vulnerabilityResults.length === 0) {
        grid.innerHTML = `
          <div class="bg-green-900/30 border border-green-700 rounded-xl p-6 text-center">
            <svg class="mx-auto h-12 w-12 text-green-500 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <h3 class="text-lg font-semibold text-green-400">No Known Vulnerabilities Found</h3>
            <p class="text-green-500 text-sm mt-1">Scanned applications appear secure based on NVD data.</p>
          </div>
        `;
        document.getElementById("vulnResults").classList.remove("hidden");
        return;
      }

      const sorted = [...vulnerabilityResults].sort((a, b) => {
        const order = { CRITICAL: 0, HIGH: 1, MEDIUM: 2, LOW: 3, UNKNOWN: 4 };
        const aMax = Math.min(...a.vulnerabilities.map(v => order[v.severity] ?? 4));
        const bMax = Math.min(...b.vulnerabilities.map(v => order[v.severity] ?? 4));
        return aMax - bMax;
      });

      for (const result of sorted) {
        let vulns = result.vulnerabilities;
        if (filter !== "all") {
          const order = { CRITICAL: 0, HIGH: 1, MEDIUM: 2, LOW: 3 };
          const threshold = order[filter];
          vulns = vulns.filter(v => (order[v.severity] ?? 4) <= threshold);
        }

        if (vulns.length === 0) continue;

        const container = document.createElement("div");
        container.className = `bg-gray-800 rounded-xl border ${getSeverityBorderClass(getHighestSeverity(vulns))} overflow-hidden`;
        
        const listId = `vuln-list-${result.productName.replace(/[^a-zA-Z0-9]/g, '-')}`;
        
        container.innerHTML = `
          <div class="p-4 bg-gray-900 border-b border-gray-700">
            <div class="flex justify-between items-start flex-wrap gap-2">
              <div>
                <h3 class="font-semibold text-white text-lg">${escapeHtml(result.productName)}</h3>
                <p class="text-sm text-gray-400 mt-1">
                  Versions: ${result.versions.slice(0, 3).join(", ")}${result.versions.length > 3 ? ` +${result.versions.length - 3}` : ""} 
                  • ${result.instanceCount} instance${result.instanceCount > 1 ? 's' : ''}
                </p>
              </div>
              <span class="px-3 py-1 text-sm font-bold rounded ${getSeverityBadgeClass(getHighestSeverity(vulns))}">
                ${vulns.length} CVE${vulns.length > 1 ? 's' : ''}
              </span>
            </div>
          </div>
          <div class="divide-y divide-gray-700" id="${listId}"></div>
        `;

        grid.appendChild(container);
        
        const list = container.querySelector(`#${listId}`);

        for (const vuln of vulns.slice(0, 10)) {
          const item = document.createElement("div");
          item.className = "p-4 hover:bg-gray-700/30 transition";
          item.innerHTML = `
            <div class="flex justify-between items-start gap-4 mb-2">
              <a href="https://nvd.nist.gov/vuln/detail/${vuln.id}" target="_blank" rel="noopener"
                 class="font-mono text-blue-400 hover:text-blue-300 font-semibold hover:underline">
                ${vuln.id}
              </a>
              <div class="flex items-center gap-2 flex-shrink-0">
                ${vuln.score ? `<span class="text-sm text-gray-400">CVSS: <span class="font-semibold text-white">${vuln.score}</span></span>` : ''}
                <span class="px-2 py-0.5 text-xs font-bold rounded ${getSeverityBadgeClass(vuln.severity)}">${vuln.severity}</span>
              </div>
            </div>
            <p class="text-sm text-gray-400 line-clamp-2">${escapeHtml(vuln.description)}</p>
            <p class="text-xs text-gray-500 mt-2">Published: ${new Date(vuln.published).toLocaleDateString()}</p>
          `;
          list.appendChild(item);
        }

        if (vulns.length > 10) {
          const more = document.createElement("div");
          more.className = "p-3 text-center text-sm text-gray-400 bg-gray-900/50";
          more.innerHTML = `<a href="https://nvd.nist.gov/vuln/search/results?query=${encodeURIComponent(result.productName)}" target="_blank" class="hover:text-white">+ ${vulns.length - 10} more → View on NVD</a>`;
          list.appendChild(more);
        }
      }

      document.getElementById("vulnResults").classList.remove("hidden");
    }

    /* ===============================
       Export
    ================================ */
    window.exportReport = function() {
      if (vulnerabilityResults.length === 0) return;

      const hostname = currentEndpoint ? (currentEndpoint.hostname || currentEndpoint.id || "Unknown") : "Unknown";
      
      let report = "SHIELD360 VULNERABILITY SCAN REPORT\n";
      report += "Generated: " + new Date().toLocaleString() + "\n";
      report += "Endpoint: " + hostname + "\n";
      report += "=".repeat(60) + "\n\n";

      report += "SUMMARY\n" + "-".repeat(40) + "\n";
      report += `Endpoint: ${hostname}\n`;
      report += `Applications: ${allApplications.length}\n`;
      report += `Products with CVEs: ${vulnerabilityResults.length}\n`;
      
      let total = 0, crit = 0, high = 0, med = 0, low = 0;
      for (const r of vulnerabilityResults) {
        for (const v of r.vulnerabilities) {
          total++;
          switch (v.severity) {
            case "CRITICAL": crit++; break;
            case "HIGH": high++; break;
            case "MEDIUM": med++; break;
            default: low++; break;
          }
        }
      }

      report += `Total CVEs: ${total} (Critical: ${crit}, High: ${high}, Medium: ${med}, Low: ${low})\n\n`;
      report += "DETAILED FINDINGS\n" + "=".repeat(60) + "\n";

      for (const r of vulnerabilityResults) {
        report += `\n${r.productName}\n` + "-".repeat(40) + "\n";
        report += `Versions: ${r.versions.join(", ")}\n`;
        report += `CVEs: ${r.vulnerabilities.length}\n\n`;

        for (const v of r.vulnerabilities.slice(0, 15)) {
          report += `  ${v.id} [${v.severity}] Score: ${v.score || 'N/A'}\n`;
          report += `  ${v.description.substring(0, 150)}...\n`;
          report += `  https://nvd.nist.gov/vuln/detail/${v.id}\n\n`;
        }
      }

      const blob = new Blob([report], { type: "text/plain" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `shield360_vuln_report_${hostname}_${new Date().toISOString().split('T')[0]}.txt`;
      a.click();
    };

    /* ===============================
       Error Handler
    ================================ */
    function showError(msg, details = "") {
      document.getElementById("loader").classList.add("hidden");
      document.getElementById("appsContainer").classList.add("hidden");
      document.getElementById("error").classList.remove("hidden");
      document.getElementById("errorMessage").textContent = msg;
      document.getElementById("errorDetails").textContent = details;
    }

    // Initialize
    loadEndpoint();
  </script>

</body>
</html>
